<!DOCTYPE html>
<html id="mainHtml" lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mirror-Smile</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mirror-Smile">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0c10">

    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"></script>
    <style>
        * { box-sizing: border-box; }
        :root { 
            --accent: #4ebaba; 
            --bg-glass: rgba(15, 20, 25, 0.92); 
            --text-main: #e0e0e0; 
            --warning: #ffb74d; 
            --record: #ff5252;
            --success: #4caf50;
            --error: #f44336;
        }
        
        body { 
            margin: 0; 
            background: #0a0c10; 
            overflow: hidden; 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            color: var(--text-main); 
        }
        
        .screen { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            flex-direction: column; 
            z-index: 200; 
            transition: opacity 0.4s ease; 
            padding: 20px; 
        }
        
        canvas { 
            position: absolute; 
            left: 50%; 
            top: 50%; 
            transform: translate(-50%, -50%); 
            max-width: 100%; 
            max-height: 100%; 
            object-fit: contain; 
            display: none; 
        }
        video { display: none; }

        #lang-toggle {
            position: absolute; 
            top: 50px; 
            left: 20px; 
            z-index: 500;
            background: rgba(255,255,255,0.15); 
            border: 1.5px solid var(--accent);
            color: var(--accent); 
            padding: 10px 18px; 
            border-radius: 25px;
            cursor: pointer; 
            font-size: 14px; 
            font-weight: bold; 
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        
        #lang-toggle:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
        }

        .content-card { 
            text-align: center; 
            padding: 25px; 
            width: 90vw; 
            max-width: 450px; 
            max-height: 85vh;
            background: var(--bg-glass); 
            border-radius: 30px; 
            backdrop-filter: blur(15px); 
            border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 15px 35px rgba(0,0,0,0.5); 
            overflow-y: auto; 
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .content-card::-webkit-scrollbar { display: none; }
        
        #app-logo { 
            width: 110px; 
            height: 110px; 
            margin-bottom: 20px; 
            border-radius: 22px; 
            border: 2.5px solid var(--accent); 
            background: #ffffff; 
            object-fit: contain; 
            padding: 8px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            opacity: 1 !important;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }

        h1 { font-size: 28px; margin: 0 0 5px 0; color: #fff; }
        .sub-title { font-size: 14px; color: var(--accent); margin-bottom: 25px; opacity: 1; font-weight: 500; }
        h2 { font-size: 19px; color: var(--accent); margin-bottom: 15px; border-bottom: 1px solid rgba(78, 186, 186, 0.3); padding-bottom: 8px; }
        
        .info-text { text-align: inherit; font-size: 13.5px; line-height: 1.6; margin-bottom: 20px; color: #f0f0f0; }
        .instructions-list { text-align: inherit; margin: 15px 0; padding: 0; list-style: none; width: 100%; }
        .instructions-list li { margin-bottom: 12px; font-size: 13px; line-height: 1.5; display: flex; align-items: flex-start; gap: 8px; }
        .instructions-list li::before { content: "â€¢"; color: var(--accent); font-weight: bold; flex-shrink: 0; margin-top: 2px; }
        
        .btn-group { display: flex; flex-direction: column; gap: 12px; width: 100%; align-items: center; }
        .main-btn { 
            width: 100%; 
            max-width: 260px; 
            padding: 14px; 
            border-radius: 30px; 
            background: var(--accent); 
            color: #000; 
            font-size: 16px; 
            font-weight: 700; 
            border: none; 
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .main-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 186, 186, 0.4);
        }
        .main-btn:active {
            transform: translateY(0);
        }
        .main-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .secondary-btn { 
            width: 100%; 
            max-width: 260px; 
            padding: 11px; 
            border-radius: 30px; 
            background: transparent; 
            color: var(--accent); 
            font-size: 14px; 
            border: 1.5px solid var(--accent); 
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .secondary-btn:hover {
            background: rgba(78, 186, 186, 0.1);
            transform: translateY(-2px);
        }
        
        .disclaimer-box { 
            background: rgba(255, 183, 77, 0.12); 
            border: 1px solid var(--warning); 
            padding: 18px; 
            border-radius: 20px; 
            text-align: inherit; 
            margin-bottom: 20px; 
            width: 100%; 
        }
        .disclaimer-box h3 { color: var(--warning); margin-top: 0; font-size: 18px; margin-bottom: 12px; }

        #ui { 
            position: absolute; 
            bottom: 40px; 
            width: 100%; 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            gap: 15px; 
            z-index: 100; 
            padding: 0 10px; 
        }
        .controls-row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
        button.tool-btn { 
            padding: 10px 14px; 
            border-radius: 15px; 
            border: 1px solid rgba(255,255,255,0.2); 
            background: rgba(255,255,255,0.1); 
            color: #fff; 
            cursor: pointer; 
            font-size: 14px;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        button.tool-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        button.active { 
            background: var(--accent); 
            color: #000; 
            border-color: var(--accent);
        }
        button.recording { 
            background: var(--record); 
            color: #fff; 
            animation: blink 1.5s infinite;
            border-color: var(--record);
        }

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .watermark { 
            position: absolute; 
            bottom: 10px; 
            font-size: 10px; 
            color: rgba(255,255,255,0.25); 
            z-index: 210; 
            width: 100%; 
            text-align: center; 
            pointer-events: none; 
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 300; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.8); 
            backdrop-filter: blur(5px); 
            justify-content: center; 
            align-items: center; 
        }
        .modal-content { 
            background: #1a1e23; 
            padding: 25px; 
            border-radius: 25px; 
            width: 85%; 
            max-width: 380px; 
            text-align: inherit; 
            border: 1px solid var(--accent); 
        }
        
        /* Loading Spinner */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 400;
            flex-direction: column;
            gap: 20px;
        }
        
        .loader {
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loader-text {
            color: var(--accent);
            font-size: 16px;
            font-weight: bold;
        }
        
        /* Toast Notifications */
        .toast { 
            position: fixed; 
            bottom: 30px; 
            left: 50%; 
            transform: translateX(-50%) translateY(100px); 
            background: #333; 
            color: white; 
            padding: 15px 30px; 
            border-radius: 10px; 
            font-weight: bold; 
            opacity: 0; 
            transition: all 0.3s; 
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.show { 
            opacity: 1; 
            transform: translateX(-50%) translateY(0); 
        }
        .toast.success {
            background: var(--success);
        }
        .toast.error {
            background: var(--error);
        }
        
        /* Error Modal */
        .error-modal {
            display: none;
            position: fixed;
            z-index: 500;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .error-content {
            background: var(--bg-glass);
            padding: 30px;
            border-radius: 25px;
            max-width: 400px;
            text-align: center;
            border: 2px solid var(--error);
        }
        
        .error-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }
        
        .error-title {
            color: var(--error);
            font-size: 22px;
            margin-bottom: 15px;
        }
        
        .error-message {
            color: var(--text-main);
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .error-btn {
            background: var(--error);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* FPS Counter (for debugging) */
        .fps-counter {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: var(--accent);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 600;
            display: none;
        }
        
        /* Guide Toggle Button */
        .guide-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 150;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            backdrop-filter: blur(10px);
            display: none;
        }
        
        .guide-toggle:hover {
            background: rgba(255,255,255,0.2);
        }
        
        /* Accessibility improvements */
        button:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        
        @media (max-width: 480px) {
            .content-card {
                padding: 20px;
            }
            h1 {
                font-size: 24px;
            }
            .main-btn, .secondary-btn {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>

    <button id="lang-toggle" onclick="toggleLanguage()" aria-label="Toggle Language">English</button>

    <!-- Loading Overlay -->
    <div class="loader-overlay" id="loaderOverlay">
        <div class="loader"></div>
        <div class="loader-text" id="loaderText">×˜×•×¢×Ÿ...</div>
    </div>

    <!-- Error Modal -->
    <div class="error-modal" id="errorModal">
        <div class="error-content">
            <div class="error-icon">âš ï¸</div>
            <h3 class="error-title" id="errorTitle">×©×’×™××”</h3>
            <p class="error-message" id="errorMessage"></p>
            <button class="error-btn" onclick="closeErrorModal()">×¡×’×•×¨</button>
        </div>
    </div>

    <!-- FPS Counter -->
    <div class="fps-counter" id="fpsCounter">FPS: 0</div>

    <!-- Guide Toggle (when camera is active) -->
    <button class="guide-toggle" id="guideToggle" onclick="toggleGuide()">
        <span id="guideText">×”×¦×’ ×§×• ×× ×—×”</span>
    </button>

    <div id="screen-1" class="screen">
        <div class="content-card">
            <img src="logo.png" id="app-logo" alt="Mirror-Smile Logo">
            <h1 data-i18n="app_title">Mirror-Smile</h1>
            <div class="sub-title" data-i18n="app_subtitle">×¤×•×ª×—×” ×¢×œ ×™×“×™ ×“×§×œ ×¦×™×“×•×Ÿ ×•×™×©×™ ×–×‘×•×œ×•×Ÿ</div>
            <div class="btn-group">
                <button class="main-btn" onclick="showScreen(3)" data-i18n="btn_instructions" aria-label="×œ×”×•×¨××•×ª ×”×©×™××•×©">×œ×”×•×¨××•×ª ×”×©×™××•×©</button>
                <button class="secondary-btn" onclick="showScreen(2)" data-i18n="btn_about" aria-label="××•×“×•×ª ×”××¤×œ×™×§×¦×™×”">××•×“×•×ª ×”××¤×œ×™×§×¦×™×”</button>
            </div>
        </div>
    </div>

    <div id="screen-2" class="screen" style="display:none; opacity:0;">
        <div class="content-card">
            <h2 data-i18n="about_title">××•×“×•×ª Mirror-Smile</h2>
            <div class="info-text" data-i18n="about_content">
                <p><strong>Mirror-Smile</strong> × ×•×œ×“×” ××ª×•×š ×¢×§×¨×•×Ÿ ×”× ×•×™×¨×•×¤×œ×¡×˜×™×•×ª â€” ×™×›×•×œ×ª×• ×©×œ ×”××•×— ×œ×”×©×ª× ×•×ª, ×œ×”×¡×ª×’×œ ×•×œ×”×—×œ×™× ×‘×¢×§×‘×•×ª ××™××•×Ÿ, ×—×–×¨×” ×•××©×•×‘ ××ª××™×.</p>
                <p>×¢×™×§×¨×•×Ÿ ×–×” ××ª×•××¨ ×‘×”×¨×—×‘×” ×‘×¡×¤×¨ â€×”××•×— ×”×’××™×©" (The Brain That Changes Itself) ×××ª × ×•×¨××Ÿ ×“×•×™×“×’'.</p>
                <p>×”××¤×œ×™×§×¦×™×” ××‘×•×¡×¡×ª ×¢×œ ×¢×§×¨×•× ×•×ª Mirror Therapy ×©×¤×•×ª×—×” ×¢×œâ€‘×™×“×™ ×”× ×•×™×¨×•×œ×•×’ <strong>Vilayanur S. Ramachandran</strong>.</p>
            </div>
            <div class="btn-group">
                <button class="secondary-btn" onclick="openModal('usersModal')" data-i18n="btn_call_users" aria-label="×§×¨×™××” ×œ××©×ª××©×™×">×§×¨×™××” ×œ××©×ª××©×™×</button>
                <button class="secondary-btn" onclick="openModal('researchModal')" data-i18n="btn_call_research" aria-label="×§×¨×™××” ×œ×—×•×§×¨×™×">×§×¨×™××” ×œ×—×•×§×¨×™×</button>
                <button class="main-btn" onclick="showScreen(3)" data-i18n="btn_continue" aria-label="×œ×”××©×š ×œ×”×•×¨××•×ª">×œ×”××©×š ×œ×”×•×¨××•×ª</button>
            </div>
        </div>
    </div>

    <div id="screen-3" class="screen" style="display:none; opacity:0;">
        <div class="content-card">
            <h2 data-i18n="instr_title">×”×•×¨××•×ª ×©×™××•×©</h2>
            <ul class="instructions-list" data-i18n="instr_list">
                <li>×”×¦×‘ ××ª ×”××›×©×™×¨ ×¢×œ ×—×¦×•×‘×”, ×™×©×™×¨×•×ª ××•×œ ×”×¤× ×™× â€” ×‘×“×•××” ×œ××¨××”</li>
                <li>×“××’ ×œ×ª××•×¨×” ××—×™×“×”, ×¡×‘×™×‘×” ×©×§×˜×” ×•×¤×¨×˜×™×•×ª</li>
                <li>××§× ××ª ×”×¤× ×™× ×‘××¨×›×– ×”××¡×š, ××‘×˜ ×™×©×¨ ×§×“×™××”</li>
                <li>×©×›×¤×œ ××ª ×”×¦×“ ×”×‘×¨×™× ×•×—×¤×© ×¡×™××˜×¨×™×” × ×•×—×” ×•×˜×‘×¢×™×ª</li>
                <li>×ª×¨×’×œ ×‘×¢×–×¨×ª ×©×ª×™ ×”×™×“×™×™× ×‘××§×‘×™×œ, ×‘×”×ª×× ×œ×”× ×—×™×•×ª ×”××˜×¤×œ ×©×œ×š</li>
            </ul>
            <button class="main-btn" onclick="showScreen(4)" data-i18n="btn_to_disclaimer" aria-label="×”××©×š ×œ××—×¨×™×•×ª ×©×™××•×©">×”××©×š ×œ××—×¨×™×•×ª ×©×™××•×©</button>
        </div>
    </div>

    <div id="screen-4" class="screen" style="display:none; opacity:0;">
        <div class="content-card">
            <div class="disclaimer-box">
                <h3 data-i18n="disc_title">××—×¨×™×•×ª ×”××©×ª××©</h3>
                <div id="disc_text" data-i18n="disc_content">
                    <p>××¤×œ×™×§×¦×™×” ×–×• ××™× ×” ××›×©×™×¨ ×¨×¤×•××™ ×•××™× ×” ××”×•×•×” ×™×™×¢×•×¥ ×¨×¤×•××™.</p>
                    <p>×”×©×™××•×© × ×¢×©×” ×‘××—×¨×™×•×ª ×”××©×ª××© ×‘×œ×‘×“. ××™×Ÿ ×œ×©× ×•×ª ×˜×™×¤×•×œ ×œ×œ× ×”×ª×™×™×¢×¦×•×ª ×¢× ×¨×•×¤×.</p>
                    <p>×‘××§×¨×” ×©×œ ×›××‘ ××• ×¡×¤×§ â€” ×™×© ×œ×”×¤×¡×™×§ ××ª ×”×©×™××•×© ×•×œ×¤× ×•×ª ×œ××™×© ××§×¦×•×¢.</p>
                </div>
            </div>
            <button class="main-btn" onclick="startCamera()" data-i18n="btn_start" aria-label="×”×‘× ×ª×™, ×‘×•××• × ×ª×—×™×œ">×”×‘× ×ª×™, ×‘×•××• × ×ª×—×™×œ</button>
        </div>
    </div>

    <video id="videoElement" playsinline autoplay muted></video>
    <canvas id="mainCanvas"></canvas>
    <canvas id="tempCanvas" style="display:none"></canvas>

    <div id="ui">
        <div class="controls-row">
            <button onclick="setMode('none')" id="btnNone" class="tool-btn active" data-i18n="btn_normal" aria-label="××¦×‘ ×¨×’×™×œ">×¨×’×™×œ</button>
            <button onclick="setMode('left')" id="btnLeft" class="tool-btn" data-i18n="btn_left" aria-label="×©×™×§×•×£ ×©×××œ">×©×××œ</button>
            <button onclick="setMode('right')" id="btnRight" class="tool-btn" data-i18n="btn_right" aria-label="×©×™×§×•×£ ×™××™×Ÿ">×™××™×Ÿ</button>
            <button onclick="takeSnapshot()" class="tool-btn" aria-label="×¦×œ× ×ª××•× ×”">ğŸ“¸</button>
            <button onclick="toggleVideoRecording()" id="btnRecord" class="tool-btn" aria-label="×”×§×œ×˜ ×•×™×“××•">ğŸ“¹</button>
            <button onclick="finishSession()" class="tool-btn" style="background: rgba(255,255,255,0.2); border-color: #fff;" data-i18n="btn_finish" aria-label="×¡×™×•× ×ª×¨×’×•×œ">×¡×™×•× âœ–</button>
        </div>
    </div>
    <div class="watermark">Â© 2026 | Mirror-Smile | Developed by Dekel Tzidon & Yishay Zvulun</div>

    <div id="usersModal" class="modal">
        <div class="modal-content">
            <h3 data-i18n="modal_users_title">×§×¨×™××” ×œ××©×ª××©×™×</h3>
            <p data-i18n="modal_users_body">×× ×• ××–××™× ×™× ×× ×©×™× ×”×¡×•×‘×œ×™× ××©×™×ª×•×§ ×¢×¦×‘ ×”×¤× ×™× ×œ×”×©×ª××© ×‘-Mirror-Smile. × ×©××— ×œ××©×•×‘.</p>
            <button class="secondary-btn" onclick="closeModal('usersModal')" data-i18n="btn_close">×¡×’×•×¨</button>
        </div>
    </div>
    
    <div id="researchModal" class="modal">
        <div class="modal-content">
            <h3 data-i18n="modal_res_title">×§×¨×™××” ×œ×—×•×§×¨×™×</h3>
            <p data-i18n="modal_res_body">×—×•×§×¨×™× ××•×–×× ×™× ×œ×”×©×ª××© ×‘××¤×œ×™×§×¦×™×” ×œ××—×§×¨ ×¢× ×§×¨×“×™×˜ ××ª××™×.</p>
            <button class="secondary-btn" onclick="closeModal('researchModal')" data-i18n="btn_close">×¡×’×•×¨</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ============================================
        // Configuration & State Management
        // ============================================
        
        const CONFIG = {
            TARGET_FPS: 30,
            FRAME_TIME: 1000 / 30,
            SMOOTHING_FACTOR: 0.15,
            VIDEO_CONSTRAINTS: { 
                facingMode: "user", 
                width: { ideal: 1280 }, 
                height: { ideal: 720 } 
            },
            STORAGE_KEY: 'mirrorSmile_settings'
        };

        const i18n = {
            he: {
                dir: 'rtl', lang_btn: 'English',
                app_title: 'Mirror-Smile', app_subtitle: '×¤×•×ª×—×” ×¢×œ ×™×“×™ ×“×§×œ ×¦×™×“×•×Ÿ ×•×™×©×™ ×–×‘×•×œ×•×Ÿ',
                btn_instructions: '×œ×”×•×¨××•×ª ×”×©×™××•×©', btn_about: '××•×“×•×ª ×”××¤×œ×™×§×¦×™×”',
                about_title: '××•×“×•×ª Mirror-Smile',
                about_content: `<p><strong>Mirror-Smile</strong> × ×•×œ×“×” ××ª×•×š ×¢×§×¨×•×Ÿ ×”× ×•×™×¨×•×¤×œ×¡×˜×™×•×ª â€” ×™×›×•×œ×ª×• ×©×œ ×”××•×— ×œ×”×©×ª× ×•×ª, ×œ×”×¡×ª×’×œ ×•×œ×”×—×œ×™× ×‘×¢×§×‘×•×ª ××™××•×Ÿ, ×—×–×¨×” ×•××©×•×‘ ××ª××™×.</p><p>×¢×™×§×¨×•×Ÿ ×–×” ××ª×•××¨ ×‘×”×¨×—×‘×” ×‘×¡×¤×¨ â€×”××•×— ×”×’××™×©" (The Brain That Changes Itself) ×××ª × ×•×¨××Ÿ ×“×•×™×“×’'.</p><p>×”××¤×œ×™×§×¦×™×” ××‘×•×¡×¡×ª ×¢×œ ×¢×§×¨×•× ×•×ª Mirror Therapy ×©×¤×•×ª×—×” ×¢×œâ€‘×™×“×™ ×”× ×•×™×¨×•×œ×•×’ <strong>Vilayanur S. Ramachandran</strong>.</p>`,
                btn_call_users: '×§×¨×™××” ×œ××©×ª××©×™×', btn_call_research: '×§×¨×™××” ×œ×—×•×§×¨×™×', btn_continue: '×œ×”××©×š ×œ×”×•×¨××•×ª',
                instr_title: '×”×•×¨××•×ª ×©×™××•×©',
                instr_list: `<li>×”×¦×‘ ××ª ×”××›×©×™×¨ ×¢×œ ×—×¦×•×‘×”, ×™×©×™×¨×•×ª ××•×œ ×”×¤× ×™× â€” ×‘×“×•××” ×œ××¨××”</li><li>×“××’ ×œ×ª××•×¨×” ××—×™×“×”, ×¡×‘×™×‘×” ×©×§×˜×” ×•×¤×¨×˜×™×•×ª</li><li>××§× ××ª ×”×¤× ×™× ×‘××¨×›×– ×”××¡×š, ××‘×˜ ×™×©×¨ ×§×“×™××”</li><li>×©×›×¤×œ ××ª ×”×¦×“ ×”×‘×¨×™× ×•×—×¤×© ×¡×™××˜×¨×™×” × ×•×—×” ×•×˜×‘×¢×™×ª</li><li>×ª×¨×’×œ ×‘×¢×–×¨×ª ×©×ª×™ ×”×™×“×™×™× ×‘××§×‘×™×œ, ×‘×”×ª×× ×œ×”× ×—×™×•×ª ×”××˜×¤×œ ×©×œ×š</li>`,
                btn_to_disclaimer: '×”××©×š ×œ××—×¨×™×•×ª ×©×™××•×©',
                disc_title: '××—×¨×™×•×ª ×”××©×ª××©',
                disc_content: `<p>××¤×œ×™×§×¦×™×” ×–×• ××™× ×” ××›×©×™×¨ ×¨×¤×•××™ ×•××™× ×” ××”×•×•×” ×™×™×¢×•×¥ ×¨×¤×•××™.</p><p>×”×©×™××•×© × ×¢×©×” ×‘××—×¨×™×•×ª ×”××©×ª××© ×‘×œ×‘×“. ××™×Ÿ ×œ×©× ×•×ª ×˜×™×¤×•×œ ×œ×œ× ×”×ª×™×™×¢×¦×•×ª ×¢× ×¨×•×¤×.</p><p>×‘××§×¨×” ×©×œ ×›××‘ ××• ×¡×¤×§ â€” ×™×© ×œ×”×¤×¡×™×§ ××ª ×”×©×™××•×© ×•×œ×¤× ×•×ª ×œ××™×© ××§×¦×•×¢.</p>`,
                btn_start: '×”×‘× ×ª×™, ×‘×•××• × ×ª×—×™×œ', 
                btn_normal: '×¨×’×™×œ', btn_left: '×©×××œ', btn_right: '×™××™×Ÿ', btn_finish: '×¡×™×•× âœ–',
                modal_users_title: '×§×¨×™××” ×œ××©×ª××©×™×', modal_users_body: '×× ×• ××–××™× ×™× ×× ×©×™× ×”×¡×•×‘×œ×™× ××©×™×ª×•×§ ×¢×¦×‘ ×”×¤× ×™× ×œ×”×©×ª××© ×‘-Mirror-Smile. × ×©××— ×œ××©×•×‘.',
                modal_res_title: '×§×¨×™××” ×œ×—×•×§×¨×™×', modal_res_body: '×—×•×§×¨×™× ××•×–×× ×™× ×œ×”×©×ª××© ×‘××¤×œ×™×§×¦×™×” ×œ××—×§×¨ ×¢× ×§×¨×“×™×˜ ××ª××™×.',
                btn_close: '×¡×’×•×¨', 
                cam_err: '×©×’×™××ª ××¦×œ××”: ×•×•×“× ×©××ª×” ×‘×—×™×‘×•×¨ ×××•×‘×˜×— (HTTPS) ×•× ×ª×ª ×”×¨×©××”.',
                loading: '×˜×•×¢×Ÿ ××•×“×œ×™×...',
                error_title: '×©×’×™××”',
                error_camera: '×œ× × ×™×ª×Ÿ ×œ×’×©×ª ×œ××¦×œ××”. ×× × ×•×•×“× ×©× ×ª×ª ×”×¨×©××•×ª ××¦×œ××” ×•×©×”××ª×¨ ×¤×•×¢×œ ×‘×—×™×‘×•×¨ ×××•×‘×˜×— (HTTPS).',
                error_models: '×©×’×™××” ×‘×˜×¢×™× ×ª ××•×“×œ×™ AI. ×× × ×‘×“×•×§ ××ª ×—×™×‘×•×¨ ×”××™× ×˜×¨× ×˜ ×•× ×¡×” ×©×•×‘.',
                error_generic: '××™×¨×¢×” ×©×’×™××” ×‘×œ×ª×™ ×¦×¤×•×™×”. ×× × ×¨×¢× ×Ÿ ××ª ×”×“×£ ×•× ×¡×” ×©×•×‘.',
                snapshot_saved: '×ª××•× ×” × ×©××¨×”! ğŸ“¸',
                recording_started: '×”×§×œ×˜×” ×”×—×œ×” ğŸ¥',
                recording_stopped: '×•×™×“××• × ×©××¨! ğŸ¬',
                guide_show: '×”×¦×’ ×§×• ×× ×—×”',
                guide_hide: '×”×¡×ª×¨ ×§×• ×× ×—×”'
            },
            en: {
                dir: 'ltr', lang_btn: '×¢×‘×¨×™×ª',
                app_title: 'Mirror-Smile', app_subtitle: 'Developed by Dekel Tzidon & Yishay Zvulun',
                btn_instructions: 'Usage Instructions', btn_about: 'About the App',
                about_title: 'About Mirror-Smile',
                about_content: `<p><strong>Mirror-Smile</strong> was born from the principle of neuroplasticity â€” the brain's ability to change, adapt, and heal through training and feedback.</p><p>This principle is described in "The Brain That Changes Itself" by Norman Doidge.</p><p>The app is based on Mirror Therapy principles developed by neurologist <strong>Vilayanur S. Ramachandran</strong>.</p>`,
                btn_call_users: 'Call for Users', btn_call_research: 'Call for Researchers', btn_continue: 'Continue to Instructions',
                instr_title: 'Instructions',
                instr_list: `<li>Place the device on a tripod, directly in front of your face.</li><li>Ensure uniform lighting and a quiet environment.</li><li>Position your face in the center, looking straight ahead.</li><li>Mirror the healthy side and find a comfortable symmetry.</li><li>Practice using both hands simultaneously as guided by your therapist.</li>`,
                btn_to_disclaimer: 'Continue to Disclaimer',
                disc_title: 'User Responsibility',
                disc_content: `<p>This app is not a medical device and does not constitute medical advice.</p><p>Use is at the user\'s sole responsibility. Do not change treatment without consulting a doctor.</p><p>In case of pain or doubt â€” stop use and consult a professional.</p>`,
                btn_start: 'I Understand, Let\'s Start',
                btn_normal: 'Normal', btn_left: 'Left', btn_right: 'Right', btn_finish: 'Finish âœ–',
                modal_users_title: 'Call for Users', modal_users_body: 'We invite people with facial nerve paralysis to use Mirror-Smile. We welcome your feedback.',
                modal_res_title: 'Call for Researchers', modal_res_body: 'Researchers are invited to use the app with proper credit.',
                btn_close: 'Close', 
                cam_err: 'Camera Error: Ensure HTTPS connection and camera permissions.',
                loading: 'Loading models...',
                error_title: 'Error',
                error_camera: 'Cannot access camera. Please ensure camera permissions are granted and the site is running on HTTPS.',
                error_models: 'Error loading AI models. Please check your internet connection and try again.',
                error_generic: 'An unexpected error occurred. Please refresh the page and try again.',
                snapshot_saved: 'Snapshot saved! ğŸ“¸',
                recording_started: 'Recording started ğŸ¥',
                recording_stopped: 'Video saved! ğŸ¬',
                guide_show: 'Show Guide',
                guide_hide: 'Hide Guide'
            }
        };

        // State
        let currentLang = loadSettings().language || 'he';
        let currentMode = loadSettings().mode || 'none';
        let showGuide = loadSettings().showGuide !== undefined ? loadSettings().showGuide : false;
        let smoothNoseX = 0;
        let selfieSegmentation = null;
        let streamRef = null;
        let isRecording = false;
        let mediaRecorder = null;
        let recordedChunks = [];
        let lastFrameTime = 0;
        let fpsFrames = 0;
        let fpsLastTime = performance.now();
        let animationFrameId = null;

        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { alpha: false, desynchronized: true });
        const tempCanvas = document.getElementById('tempCanvas');
        const tCtx = tempCanvas.getContext('2d', { alpha: false });

        // ============================================
        // Utility Functions
        // ============================================

        function loadSettings() {
            try {
                const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
                return saved ? JSON.parse(saved) : {};
            } catch (e) {
                return {};
            }
        }

        function saveSettings(settings) {
            try {
                const current = loadSettings();
                localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify({ ...current, ...settings }));
            } catch (e) {
                console.warn('Could not save settings to localStorage');
            }
        }

        function showLoader(text) {
            const overlay = document.getElementById('loaderOverlay');
            const loaderText = document.getElementById('loaderText');
            loaderText.textContent = text || i18n[currentLang].loading;
            overlay.style.display = 'flex';
        }

        function hideLoader() {
            document.getElementById('loaderOverlay').style.display = 'none';
        }

        function showError(message, title) {
            const modal = document.getElementById('errorModal');
            const titleEl = document.getElementById('errorTitle');
            const messageEl = document.getElementById('errorMessage');
            
            titleEl.textContent = title || i18n[currentLang].error_title;
            messageEl.textContent = message;
            modal.style.display = 'flex';
        }

        function closeErrorModal() {
            document.getElementById('errorModal').style.display = 'none';
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function updateFPS() {
            fpsFrames++;
            const now = performance.now();
            const delta = now - fpsLastTime;
            
            if (delta >= 1000) {
                const fps = Math.round((fpsFrames * 1000) / delta);
                document.getElementById('fpsCounter').textContent = `FPS: ${fps}`;
                fpsFrames = 0;
                fpsLastTime = now;
            }
        }

        // ============================================
        // Language & UI Functions
        // ============================================

        function toggleLanguage() {
            currentLang = (currentLang === 'he') ? 'en' : 'he';
            saveSettings({ language: currentLang });
            const langData = i18n[currentLang];
            document.getElementById('mainHtml').dir = langData.dir;
            document.getElementById('lang-toggle').innerText = langData.lang_btn;
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (langData[key]) {
                    if (['UL','DIV','P'].includes(el.tagName)) {
                        el.innerHTML = langData[key];
                    } else {
                        el.innerText = langData[key];
                    }
                }
            });
            
            // Update guide button text if visible
            if (document.getElementById('guideToggle').style.display !== 'none') {
                document.getElementById('guideText').textContent = 
                    showGuide ? i18n[currentLang].guide_hide : i18n[currentLang].guide_show;
            }
        }

        function showScreen(num) {
            document.querySelectorAll('.screen').forEach(s => { 
                s.style.opacity = '0'; 
                setTimeout(() => s.style.display = 'none', 400); 
            });
            
            setTimeout(() => { 
                const targetScreen = document.getElementById('screen-' + num); 
                targetScreen.style.display = 'flex'; 
                setTimeout(() => targetScreen.style.opacity = '1', 50); 
            }, 450);
        }

        function openModal(id) { 
            document.getElementById(id).style.display = 'flex'; 
        }

        function closeModal(id) { 
            document.getElementById(id).style.display = 'none'; 
        }

        // ============================================
        // Camera & Model Initialization
        // ============================================

        async function startCamera() {
            const startBtn = event.target;
            startBtn.disabled = true;
            
            try {
                document.getElementById('lang-toggle').style.display = 'none';
                showLoader(i18n[currentLang].loading);
                
                await initModels();
                
                document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
                canvas.style.display = 'block';
                document.getElementById('ui').style.display = 'flex';
                document.getElementById('guideToggle').style.display = 'block';
                
                hideLoader();
            } catch (error) {
                hideLoader();
                startBtn.disabled = false;
                console.error('Startup error:', error);
            }
        }

        async function initModels() {
            try {
                // Check browser support
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('BROWSER_NOT_SUPPORTED');
                }

                // Load Face-API models
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
                await faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
                
                // Initialize MediaPipe
                selfieSegmentation = new SelfieSegmentation({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`
                });
                selfieSegmentation.setOptions({ modelSelection: 1 });
                selfieSegmentation.onResults(onResults);
                
                // Request camera access
                streamRef = await navigator.mediaDevices.getUserMedia({ 
                    video: CONFIG.VIDEO_CONSTRAINTS 
                });
                
                video.srcObject = streamRef;
                
                video.onloadedmetadata = () => { 
                    canvas.width = tempCanvas.width = video.videoWidth; 
                    canvas.height = tempCanvas.height = video.videoHeight; 
                    smoothNoseX = canvas.width / 2; 
                    startProcessing();
                };
                
            } catch (error) {
                console.error('Model initialization error:', error);
                
                let errorMessage = i18n[currentLang].error_generic;
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage = i18n[currentLang].error_camera;
                } else if (error.message === 'BROWSER_NOT_SUPPORTED') {
                    errorMessage = 'Your browser does not support camera access. Please use a modern browser.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No camera found on this device.';
                } else if (error.message.includes('model') || error.message.includes('fetch')) {
                    errorMessage = i18n[currentLang].error_models;
                }
                
                showError(errorMessage);
                throw error;
            }
        }

        function startProcessing() {
            const processFrame = async () => {
                const now = performance.now();
                const elapsed = now - lastFrameTime;
                
                if (elapsed > CONFIG.FRAME_TIME) {
                    lastFrameTime = now - (elapsed % CONFIG.FRAME_TIME);
                    
                    if (streamRef && !video.paused && !video.ended && video.readyState === video.HAVE_ENOUGH_DATA) {
                        await selfieSegmentation.send({ image: video });
                        updateFPS();
                    }
                }
                
                animationFrameId = requestAnimationFrame(processFrame);
            };
            
            processFrame();
        }

        function finishSession() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            if (isRecording) {
                toggleVideoRecording();
            }
            
            if (streamRef) { 
                streamRef.getTracks().forEach(t => t.stop()); 
                streamRef = null; 
            }
            
            if (selfieSegmentation) {
                selfieSegmentation.close();
                selfieSegmentation = null;
            }
            
            location.reload();
        }

        // ============================================
        // Video Processing & Rendering
        // ============================================

        function onResults(results) {
            // Draw segmented image to temp canvas
            tCtx.save();
            tCtx.clearRect(0, 0, canvas.width, canvas.height);
            tCtx.translate(canvas.width, 0);
            tCtx.scale(-1, 1);
            tCtx.drawImage(results.segmentationMask, 0, 0, canvas.width, canvas.height);
            tCtx.globalCompositeOperation = 'source-in';
            tCtx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
            tCtx.restore();
            
            // Detect face and update nose position
            handleFaceDetection();
            
            // Render to main canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (currentMode === 'none') {
                ctx.drawImage(tempCanvas, 0, 0);
            } else if (currentMode === 'left') {
                drawSymmetry(0, smoothNoseX);
            } else {
                drawSymmetry(smoothNoseX, canvas.width - smoothNoseX);
            }
            
            // Draw guide line if enabled
            if (showGuide && currentMode !== 'none') {
                ctx.save();
                ctx.strokeStyle = 'rgba(78, 186, 186, 0.8)';
                ctx.lineWidth = 2;
                ctx.setLineDash([10, 5]);
                ctx.beginPath();
                ctx.moveTo(smoothNoseX, 0);
                ctx.lineTo(smoothNoseX, canvas.height);
                ctx.stroke();
                ctx.restore();
            }
        }

        async function handleFaceDetection() {
            try {
                const detections = await faceapi
                    .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks();
                
                if (detections.length > 0) {
                    const nose = detections[0].landmarks.getNose()[0];
                    const noseX = canvas.width - nose.x;
                    smoothNoseX += (noseX - smoothNoseX) * CONFIG.SMOOTHING_FACTOR;
                }
            } catch (error) {
                console.warn('Face detection error:', error);
            }
        }

        function drawSymmetry(sourceX, width) {
            // Draw original side
            ctx.drawImage(tempCanvas, sourceX, 0, width, canvas.height, sourceX, 0, width, canvas.height);
            
            // Draw mirrored side
            ctx.save();
            ctx.translate(smoothNoseX * 2, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(tempCanvas, sourceX, 0, width, canvas.height, sourceX, 0, width, canvas.height);
            ctx.restore();
        }

        // ============================================
        // Control Functions
        // ============================================

        function setMode(mode) { 
            currentMode = mode;
            saveSettings({ mode: mode });
            
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active')); 
            const btnId = 'btn' + mode.charAt(0).toUpperCase() + mode.slice(1);
            const btn = document.getElementById(btnId);
            if (btn) btn.classList.add('active');
        }

        function toggleGuide() {
            showGuide = !showGuide;
            saveSettings({ showGuide: showGuide });
            document.getElementById('guideText').textContent = 
                showGuide ? i18n[currentLang].guide_hide : i18n[currentLang].guide_show;
        }

        function takeSnapshot() { 
            try {
                const link = document.createElement('a'); 
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                link.download = `Mirror-Smile_${timestamp}.png`; 
                link.href = canvas.toDataURL('image/png'); 
                link.click();
                showToast(i18n[currentLang].snapshot_saved, 'success');
            } catch (error) {
                console.error('Snapshot error:', error);
                showToast('Error saving snapshot', 'error');
            }
        }

        function toggleVideoRecording() {
            if (!isRecording) {
                try {
                    recordedChunks = [];
                    const stream = canvas.captureStream(30);
                    
                    let options = { mimeType: 'video/webm;codecs=vp9' };
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                        options = { mimeType: 'video/webm' };
                    }
                    
                    mediaRecorder = new MediaRecorder(stream, options);
                    
                    mediaRecorder.ondataavailable = e => {
                        if (e.data.size > 0) {
                            recordedChunks.push(e.data);
                        }
                    };
                    
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(recordedChunks, { type: 'video/webm' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                        a.href = url;
                        a.download = `Mirror-Smile_${timestamp}.webm`;
                        a.click();
                        URL.revokeObjectURL(url);
                        showToast(i18n[currentLang].recording_stopped, 'success');
                    };
                    
                    mediaRecorder.start();
                    document.getElementById('btnRecord').classList.add('recording');
                    isRecording = true;
                    showToast(i18n[currentLang].recording_started, 'success');
                } catch (error) {
                    console.error('Recording error:', error);
                    showToast('Error starting recording', 'error');
                }
            } else {
                try {
                    mediaRecorder.stop();
                    document.getElementById('btnRecord').classList.remove('recording');
                    isRecording = false;
                } catch (error) {
                    console.error('Stop recording error:', error);
                }
            }
        }

        // ============================================
        // Initialization
        // ============================================

        // Apply saved language on load
        if (currentLang !== 'he') {
            toggleLanguage();
        }

        // Apply saved mode
        if (currentMode !== 'none') {
            setMode(currentMode);
        }

        // Update guide button text
        document.getElementById('guideText').textContent = 
            showGuide ? i18n[currentLang].guide_hide : i18n[currentLang].guide_show;

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (streamRef) { // Only when camera is active
                switch(e.key) {
                    case '1':
                        setMode('none');
                        break;
                    case '2':
                        setMode('left');
                        break;
                    case '3':
                        setMode('right');
                        break;
                    case 's':
                        takeSnapshot();
                        break;
                    case 'r':
                        toggleVideoRecording();
                        break;
                    case 'g':
                        toggleGuide();
                        break;
                    case 'Escape':
                        if (confirm('Are you sure you want to exit?')) {
                            finishSession();
                        }
                        break;
                }
            }
        });

        // Prevent accidental page unload
        window.addEventListener('beforeunload', (e) => {
            if (streamRef) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Handle visibility change (pause when tab is hidden)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && isRecording) {
                // Optionally pause recording when tab is hidden
                console.log('Tab hidden while recording');
            }
        });

        console.log('Mirror-Smile initialized successfully');
    </script>
</body>
</html>
